name: Release Game Pack

on:
  push:
    tags:
      - 'game/*/[0-9]+.[0-9]+'
      - 'pack/*/[0-9]+.[0-9]+'

jobs:
  release:
    runs-on: ubuntu-latest
    
    if: "!contains(github.ref, '/latest')"
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Parse tag info
        id: tag_info
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          
          RELEASE_TYPE=$(echo "$TAG" | cut -d'/' -f1)
          PACK_NAME=$(echo "$TAG" | cut -d'/' -f2)
          VERSION=$(echo "$TAG" | cut -d'/' -f3)
          
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "release_type=$RELEASE_TYPE" >> $GITHUB_OUTPUT
          echo "pack_name=$PACK_NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
          echo "ðŸ“¦ Type: $RELEASE_TYPE"
          echo "ðŸ“¦ Pack: $PACK_NAME"
          echo "ðŸ·ï¸  Version: $VERSION"
      
      - name: Determine source directory
        id: config
        run: |
          RELEASE_TYPE="${{ steps.tag_info.outputs.release_type }}"
          PACK_NAME="${{ steps.tag_info.outputs.pack_name }}"
          
          SOURCE_DIR=""
          
          case "$RELEASE_TYPE" in
            game)
              if [ -d "games/$PACK_NAME" ]; then
                SOURCE_DIR="games/$PACK_NAME"
              fi
              ;;
            pack)
              if [ -d "packs/$PACK_NAME" ]; then
                SOURCE_DIR="packs/$PACK_NAME"
              elif [ -d "decks/$PACK_NAME" ]; then
                SOURCE_DIR="decks/$PACK_NAME"
              fi
              ;;
          esac
          
          if [ -z "$SOURCE_DIR" ] || [ ! -d "$SOURCE_DIR" ]; then
            echo "âŒ Error: Could not find source directory for $RELEASE_TYPE/$PACK_NAME"
            echo ""
            echo "Searched locations:"
            case "$RELEASE_TYPE" in
              game) echo "  - games/$PACK_NAME" ;;
              pack) echo "  - packs/$PACK_NAME"; echo "  - decks/$PACK_NAME" ;;
            esac
            echo ""
            echo "Available directories:"
            echo "games/:"
            ls -1 games/ 2>/dev/null || echo "  (not found)"
            echo "packs/:"
            ls -1 packs/ 2>/dev/null || echo "  (not found)"
            echo "decks/:"
            ls -1 decks/ 2>/dev/null || echo "  (not found)"
            exit 1
          fi
          
          if [ "$RELEASE_TYPE" = "game" ]; then
            REQUIRE_MANIFEST="true"
            CREATE_LATEST="true"
          else
            REQUIRE_MANIFEST="false"
            CREATE_LATEST="false"
          fi
          
          echo "dir=$SOURCE_DIR" >> $GITHUB_OUTPUT
          echo "require_manifest=$REQUIRE_MANIFEST" >> $GITHUB_OUTPUT
          echo "create_latest=$CREATE_LATEST" >> $GITHUB_OUTPUT
          
          echo ""
          echo "ðŸ“‚ Source: $SOURCE_DIR"
          echo "ðŸ“‹ Require manifest: $REQUIRE_MANIFEST"
          echo "ðŸ”„ Create latest: $CREATE_LATEST"
      
      - name: Prepare release assets
        id: prepare
        run: |
          SOURCE_DIR="${{ steps.config.outputs.dir }}"
          VERSION="${{ steps.tag_info.outputs.version }}"
          REQUIRE_MANIFEST="${{ steps.config.outputs.require_manifest }}"
          ASSETS_DIR="release_assets"
          
          mkdir -p "$ASSETS_DIR"
          
          echo "=== Preparing release assets ==="
          echo ""
          
          # Track what's included
          HAS_MANIFEST="false"
          HAS_RULES="false"
          HAS_CARDS="false"
          HAS_ASSETS="false"
          
          # Manifest
          if [ -f "$SOURCE_DIR/manifest.json" ]; then
            jq --arg v "$VERSION" '.version = $v' "$SOURCE_DIR/manifest.json" > "$ASSETS_DIR/manifest.json"
            echo "âœ“ manifest.json (version: $VERSION)"
            HAS_MANIFEST="true"
          elif [ "$REQUIRE_MANIFEST" = "true" ]; then
            echo "âŒ Error: manifest.json required for 'game' releases"
            exit 1
          else
            echo "âŠ˜ manifest.json (not found, skipping)"
          fi
          
          # Rules
          if [ -f "$SOURCE_DIR/rules.lua" ]; then
            cp "$SOURCE_DIR/rules.lua" "$ASSETS_DIR/"
            echo "âœ“ rules.lua"
            HAS_RULES="true"
          else
            echo "âŠ˜ rules.lua (not found, skipping)"
          fi
          
          # Cards.json
          if [ -f "$SOURCE_DIR/cards.json" ]; then
            cp "$SOURCE_DIR/cards.json" "$ASSETS_DIR/"
            echo "âœ“ cards.json"
            HAS_CARDS="true"
          else
            echo "âŠ˜ cards.json (not found, skipping)"
          fi
          
          # Assets zip
          if [ -d "$SOURCE_DIR/cards" ]; then
            FILE_COUNT=$(ls -1 "$SOURCE_DIR/cards" | wc -l)
            if [ "$FILE_COUNT" -gt 0 ]; then
              (cd "$SOURCE_DIR/cards" && zip -r "../../../$ASSETS_DIR/assets.zip" ./*)
              echo "âœ“ assets.zip ($FILE_COUNT files)"
              HAS_ASSETS="true"
            else
              echo "âŠ˜ cards/ folder empty (skipping)"
            fi
          else
            echo "âŠ˜ cards/ folder (not found, skipping)"
          fi
          
          echo ""
          echo "=== Release assets ==="
          ls -la "$ASSETS_DIR"
          
          if [ -z "$(ls -A $ASSETS_DIR 2>/dev/null)" ]; then
            echo ""
            echo "âŒ Error: No assets to release!"
            exit 1
          fi
          
          echo "has_manifest=$HAS_MANIFEST" >> $GITHUB_OUTPUT
          echo "has_rules=$HAS_RULES" >> $GITHUB_OUTPUT
          echo "has_cards=$HAS_CARDS" >> $GITHUB_OUTPUT
          echo "has_assets=$HAS_ASSETS" >> $GITHUB_OUTPUT
      
      - name: Check for changelog
        id: changelog
        run: |
          SOURCE_DIR="${{ steps.config.outputs.dir }}"
          VERSION="${{ steps.tag_info.outputs.version }}"
          
          CHANGELOG_CONTENT=""
          
          # Check for CHANGELOG.md in the pack folder
          if [ -f "$SOURCE_DIR/CHANGELOG.md" ]; then
            # Extract section for this version
            # Matches headers like: ## 1.0 or ## [1.0] or ## v1.0
            CHANGELOG_CONTENT=$(awk "/^## \\[?v?${VERSION}\\]?/,/^## \\[?v?[0-9]/" "$SOURCE_DIR/CHANGELOG.md" | head -n -1)
            
            if [ -n "$CHANGELOG_CONTENT" ]; then
              echo "âœ“ Found changelog for v$VERSION"
            else
              echo "âŠ˜ No changelog entry for v$VERSION"
            fi
          else
            echo "âŠ˜ No CHANGELOG.md found"
          fi
          
          # Save to file for multiline support
          echo "$CHANGELOG_CONTENT" > /tmp/changelog.md
          
          if [ -n "$CHANGELOG_CONTENT" ]; then
            echo "has_changelog=true" >> $GITHUB_OUTPUT
          else
            echo "has_changelog=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Generate release body
        id: body
        run: |
          TAG="${{ steps.tag_info.outputs.tag }}"
          PACK_NAME="${{ steps.tag_info.outputs.pack_name }}"
          VERSION="${{ steps.tag_info.outputs.version }}"
          RELEASE_TYPE="${{ steps.tag_info.outputs.release_type }}"
          REPO="${{ github.repository }}"
          
          HAS_MANIFEST="${{ steps.prepare.outputs.has_manifest }}"
          HAS_RULES="${{ steps.prepare.outputs.has_rules }}"
          HAS_CARDS="${{ steps.prepare.outputs.has_cards }}"
          HAS_ASSETS="${{ steps.prepare.outputs.has_assets }}"
          HAS_CHANGELOG="${{ steps.changelog.outputs.has_changelog }}"
          
          BASE_URL="https://github.com/$REPO/releases/download/$TAG"
          
          # Start building release body
          cat << 'HEADER' > /tmp/release_body.md
          ## $PACK_NAME v$VERSION
          
          **Type:** `$RELEASE_TYPE`
          
          ### ðŸ“¥ Asset Links
          HEADER
          
          # Replace variables in header
          sed -i "s/\$PACK_NAME/$PACK_NAME/g" /tmp/release_body.md
          sed -i "s/\$VERSION/$VERSION/g" /tmp/release_body.md
          sed -i "s/\$RELEASE_TYPE/$RELEASE_TYPE/g" /tmp/release_body.md
          
          # Add asset links (manifest first if exists)
          if [ "$HAS_MANIFEST" = "true" ]; then
            echo "**manifest.json** (add this to Cardback):" >> /tmp/release_body.md
            echo '```' >> /tmp/release_body.md
            echo "$BASE_URL/manifest.json" >> /tmp/release_body.md
            echo '```' >> /tmp/release_body.md
            echo "" >> /tmp/release_body.md
          fi
          
          if [ "$HAS_RULES" = "true" ]; then
            echo "**rules.lua:**" >> /tmp/release_body.md
            echo '```' >> /tmp/release_body.md
            echo "$BASE_URL/rules.lua" >> /tmp/release_body.md
            echo '```' >> /tmp/release_body.md
            echo "" >> /tmp/release_body.md
          fi
          
          if [ "$HAS_CARDS" = "true" ]; then
            echo "**cards.json:**" >> /tmp/release_body.md
            echo '```' >> /tmp/release_body.md
            echo "$BASE_URL/cards.json" >> /tmp/release_body.md
            echo '```' >> /tmp/release_body.md
            echo "" >> /tmp/release_body.md
          fi
          
          if [ "$HAS_ASSETS" = "true" ]; then
            echo "**assets.zip:**" >> /tmp/release_body.md
            echo '```' >> /tmp/release_body.md
            echo "$BASE_URL/assets.zip" >> /tmp/release_body.md
            echo '```' >> /tmp/release_body.md
            echo "" >> /tmp/release_body.md
          fi
          
          # Add changelog if exists
          if [ "$HAS_CHANGELOG" = "true" ]; then
            echo "---" >> /tmp/release_body.md
            echo "" >> /tmp/release_body.md
            echo "### ðŸ“ Changes" >> /tmp/release_body.md
            cat /tmp/changelog.md >> /tmp/release_body.md
          fi
          
          echo "Generated release body:"
          cat /tmp/release_body.md
      
      - name: Generate latest release body
        if: steps.config.outputs.create_latest == 'true'
        run: |
          TAG="${{ steps.tag_info.outputs.tag }}"
          PACK_NAME="${{ steps.tag_info.outputs.pack_name }}"
          VERSION="${{ steps.tag_info.outputs.version }}"
          RELEASE_TYPE="${{ steps.tag_info.outputs.release_type }}"
          REPO="${{ github.repository }}"
          
          HAS_MANIFEST="${{ steps.prepare.outputs.has_manifest }}"
          HAS_RULES="${{ steps.prepare.outputs.has_rules }}"
          HAS_CARDS="${{ steps.prepare.outputs.has_cards }}"
          HAS_ASSETS="${{ steps.prepare.outputs.has_assets }}"
          
          LATEST_TAG="$RELEASE_TYPE/$PACK_NAME/latest"
          BASE_URL="https://github.com/$REPO/releases/download/$LATEST_TAG"
          
          cat << HEADER > /tmp/latest_body.md
          ## $PACK_NAME - Latest Release
          
          **ðŸ“Œ Current version: v$VERSION**
          
          ### ðŸ“¥ Asset Links
          HEADER
          
          if [ "$HAS_MANIFEST" = "true" ]; then
            echo "**manifest.json** (add this to Cardback):" >> /tmp/latest_body.md
            echo '```' >> /tmp/latest_body.md
            echo "$BASE_URL/manifest.json" >> /tmp/latest_body.md
            echo '```' >> /tmp/latest_body.md
            echo "" >> /tmp/latest_body.md
          fi
          
          if [ "$HAS_RULES" = "true" ]; then
            echo "**rules.lua:**" >> /tmp/latest_body.md
            echo '```' >> /tmp/latest_body.md
            echo "$BASE_URL/rules.lua" >> /tmp/latest_body.md
            echo '```' >> /tmp/latest_body.md
            echo "" >> /tmp/latest_body.md
          fi
          
          if [ "$HAS_CARDS" = "true" ]; then
            echo "**cards.json:**" >> /tmp/latest_body.md
            echo '```' >> /tmp/latest_body.md
            echo "$BASE_URL/cards.json" >> /tmp/latest_body.md
            echo '```' >> /tmp/latest_body.md
            echo "" >> /tmp/latest_body.md
          fi
          
          if [ "$HAS_ASSETS" = "true" ]; then
            echo "**assets.zip:**" >> /tmp/latest_body.md
            echo '```' >> /tmp/latest_body.md
            echo "$BASE_URL/assets.zip" >> /tmp/latest_body.md
            echo '```' >> /tmp/latest_body.md
            echo "" >> /tmp/latest_body.md
          fi
      
      - name: Delete existing versioned release (if any)
        run: |
          TAG="${{ steps.tag_info.outputs.tag }}"
          gh release delete "$TAG" --yes 2>/dev/null || true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Create versioned release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag_info.outputs.tag }}
          name: "${{ steps.tag_info.outputs.release_type }}/${{ steps.tag_info.outputs.pack_name }} v${{ steps.tag_info.outputs.version }}"
          draft: false
          prerelease: false
          body_path: /tmp/release_body.md
          files: release_assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Delete existing latest release (if any)
        if: steps.config.outputs.create_latest == 'true'
        run: |
          RELEASE_TYPE="${{ steps.tag_info.outputs.release_type }}"
          PACK_NAME="${{ steps.tag_info.outputs.pack_name }}"
          LATEST_TAG="${RELEASE_TYPE}/${PACK_NAME}/latest"
          
          gh release delete "$LATEST_TAG" --yes 2>/dev/null || true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Update latest tag
        if: steps.config.outputs.create_latest == 'true'
        run: |
          RELEASE_TYPE="${{ steps.tag_info.outputs.release_type }}"
          PACK_NAME="${{ steps.tag_info.outputs.pack_name }}"
          LATEST_TAG="${RELEASE_TYPE}/${PACK_NAME}/latest"
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git tag -d "$LATEST_TAG" 2>/dev/null || true
          git push origin ":refs/tags/$LATEST_TAG" 2>/dev/null || true
          
          git tag "$LATEST_TAG"
          git push origin "$LATEST_TAG"
          
          echo "âœ“ Updated $LATEST_TAG"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Create latest release
        if: steps.config.outputs.create_latest == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag_info.outputs.release_type }}/${{ steps.tag_info.outputs.pack_name }}/latest
          name: "${{ steps.tag_info.outputs.pack_name }} (Latest)"
          draft: false
          prerelease: false
          body_path: /tmp/latest_body.md
          files: release_assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Print summary
        run: |
          RELEASE_TYPE="${{ steps.tag_info.outputs.release_type }}"
          PACK_NAME="${{ steps.tag_info.outputs.pack_name }}"
          VERSION="${{ steps.tag_info.outputs.version }}"
          REPO="${{ github.repository }}"
          TAG="${{ steps.tag_info.outputs.tag }}"
          CREATE_LATEST="${{ steps.config.outputs.create_latest }}"
          
          echo ""
          echo "=============================================="
          echo "ðŸŽ‰ Release complete!"
          echo "=============================================="
          echo ""
          echo "ðŸ“¦ $RELEASE_TYPE/$PACK_NAME v$VERSION"
          echo ""
          echo "ðŸ”— Release:"
          echo "   https://github.com/$REPO/releases/tag/$TAG"
          
          if [ "$CREATE_LATEST" = "true" ]; then
            echo ""
            echo "ðŸ”„ Latest:"
            echo "   https://github.com/$REPO/releases/tag/$RELEASE_TYPE/$PACK_NAME/latest"
          fi
          
          echo ""