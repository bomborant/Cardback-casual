name: Release Game Pack

on:
  push:
    tags:
      - 'game/*/[0-9]+.[0-9]+'
      - 'pack/*/[0-9]+.[0-9]+'

jobs:
  release:
    runs-on: ubuntu-latest
    
    if: "!contains(github.ref, '/latest')"
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Needed to list all tags
      
      - name: Parse tag info
        id: tag_info
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          
          RELEASE_TYPE=$(echo "$TAG" | cut -d'/' -f1)
          PACK_NAME=$(echo "$TAG" | cut -d'/' -f2)
          VERSION=$(echo "$TAG" | cut -d'/' -f3)
          
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "release_type=$RELEASE_TYPE" >> $GITHUB_OUTPUT
          echo "pack_name=$PACK_NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
          echo "ðŸ“¦ Type: $RELEASE_TYPE"
          echo "ðŸ“¦ Pack: $PACK_NAME"
          echo "ðŸ·ï¸  Version: $VERSION"
      
      - name: Determine source directory
        id: config
        run: |
          RELEASE_TYPE="${{ steps.tag_info.outputs.release_type }}"
          PACK_NAME="${{ steps.tag_info.outputs.pack_name }}"
          
          SOURCE_DIR=""
          
          case "$RELEASE_TYPE" in
            game)
              if [ -d "games/$PACK_NAME" ]; then
                SOURCE_DIR="games/$PACK_NAME"
              fi
              ;;
            pack)
              if [ -d "packs/$PACK_NAME" ]; then
                SOURCE_DIR="packs/$PACK_NAME"
              elif [ -d "decks/$PACK_NAME" ]; then
                SOURCE_DIR="decks/$PACK_NAME"
              fi
              ;;
          esac
          
          if [ -z "$SOURCE_DIR" ] || [ ! -d "$SOURCE_DIR" ]; then
            echo "âŒ Error: Could not find source directory for $RELEASE_TYPE/$PACK_NAME"
            echo ""
            echo "Searched locations:"
            case "$RELEASE_TYPE" in
              game) echo "  - games/$PACK_NAME" ;;
              pack) echo "  - packs/$PACK_NAME"; echo "  - decks/$PACK_NAME" ;;
            esac
            echo ""
            echo "Available directories:"
            echo "games/:"
            ls -1 games/ 2>/dev/null || echo "  (not found)"
            echo "packs/:"
            ls -1 packs/ 2>/dev/null || echo "  (not found)"
            echo "decks/:"
            ls -1 decks/ 2>/dev/null || echo "  (not found)"
            exit 1
          fi
          
          if [ "$RELEASE_TYPE" = "game" ]; then
            REQUIRE_MANIFEST="true"
            CREATE_LATEST="true"
          else
            REQUIRE_MANIFEST="false"
            CREATE_LATEST="false"
          fi
          
          echo "dir=$SOURCE_DIR" >> $GITHUB_OUTPUT
          echo "require_manifest=$REQUIRE_MANIFEST" >> $GITHUB_OUTPUT
          echo "create_latest=$CREATE_LATEST" >> $GITHUB_OUTPUT
          
          echo ""
          echo "ðŸ“‚ Source: $SOURCE_DIR"
          echo "ðŸ“‹ Require manifest: $REQUIRE_MANIFEST"
          echo "ðŸ”„ Create latest: $CREATE_LATEST"
      
      - name: Prepare release assets
        id: prepare
        run: |
          SOURCE_DIR="${{ steps.config.outputs.dir }}"
          VERSION="${{ steps.tag_info.outputs.version }}"
          REQUIRE_MANIFEST="${{ steps.config.outputs.require_manifest }}"
          ASSETS_DIR="release_assets"
          
          mkdir -p "$ASSETS_DIR"
          
          echo "=== Preparing release assets ==="
          echo ""
          
          HAS_MANIFEST="false"
          HAS_RULES="false"
          HAS_CARDS="false"
          HAS_ASSETS="false"
          
          # Manifest
          if [ -f "$SOURCE_DIR/manifest.json" ]; then
            jq --arg v "$VERSION" '.version = $v' "$SOURCE_DIR/manifest.json" > "$ASSETS_DIR/manifest.json"
            echo "âœ“ manifest.json (version: $VERSION)"
            HAS_MANIFEST="true"
          elif [ "$REQUIRE_MANIFEST" = "true" ]; then
            echo "âŒ Error: manifest.json required for 'game' releases"
            exit 1
          else
            echo "âŠ˜ manifest.json (not found, skipping)"
          fi
          
          # Rules
          if [ -f "$SOURCE_DIR/rules.lua" ]; then
            cp "$SOURCE_DIR/rules.lua" "$ASSETS_DIR/"
            echo "âœ“ rules.lua"
            HAS_RULES="true"
          else
            echo "âŠ˜ rules.lua (not found, skipping)"
          fi
          
          # Cards.json
          if [ -f "$SOURCE_DIR/cards.json" ]; then
            cp "$SOURCE_DIR/cards.json" "$ASSETS_DIR/"
            echo "âœ“ cards.json"
            HAS_CARDS="true"
          else
            echo "âŠ˜ cards.json (not found, skipping)"
          fi
          
          # Assets zip - include all folders under assets/ directory
          if [ -d "$SOURCE_DIR/assets" ]; then
            echo ""
            echo "Found assets/ directory, scanning subfolders..."
            
            ASSET_FOLDERS=""
            ASSET_COUNT=0
            
            # Find all subdirectories in assets/
            for folder_path in "$SOURCE_DIR/assets"/*/; do
              if [ -d "$folder_path" ]; then
                folder=$(basename "$folder_path")
                FILE_COUNT=$(find "$folder_path" -type f | wc -l)
                if [ "$FILE_COUNT" -gt 0 ]; then
                  ASSET_FOLDERS="$ASSET_FOLDERS $folder"
                  ASSET_COUNT=$((ASSET_COUNT + FILE_COUNT))
                  echo "  Found $folder/ ($FILE_COUNT files)"
                fi
              fi
            done
            
            if [ -n "$ASSET_FOLDERS" ]; then
              # Zip from inside assets/ directory to preserve folder structure
              (cd "$SOURCE_DIR/assets" && zip -r "../../../$ASSETS_DIR/assets.zip" $ASSET_FOLDERS)
              echo "âœ“ assets.zip ($ASSET_COUNT files in:$ASSET_FOLDERS)"
              HAS_ASSETS="true"
              
              # Show zip contents for verification
              echo ""
              echo "  Zip contents preview:"
              unzip -l "$ASSETS_DIR/assets.zip" | head -20
            else
              echo "âŠ˜ No subfolders with files found in assets/"
            fi
          else
            echo "âŠ˜ No assets/ folder found"
          fi
          
          echo ""
          echo "=== Release assets ==="
          ls -la "$ASSETS_DIR"
          
          if [ -z "$(ls -A $ASSETS_DIR 2>/dev/null)" ]; then
            echo ""
            echo "âŒ Error: No assets to release!"
            exit 1
          fi
          
          echo "has_manifest=$HAS_MANIFEST" >> $GITHUB_OUTPUT
          echo "has_rules=$HAS_RULES" >> $GITHUB_OUTPUT
          echo "has_cards=$HAS_CARDS" >> $GITHUB_OUTPUT
          echo "has_assets=$HAS_ASSETS" >> $GITHUB_OUTPUT
      
      - name: Check for changelog
        id: changelog
        run: |
          SOURCE_DIR="${{ steps.config.outputs.dir }}"
          VERSION="${{ steps.tag_info.outputs.version }}"
          
          CHANGELOG_CONTENT=""
          
          if [ -f "$SOURCE_DIR/CHANGELOG.md" ]; then
            echo "Found CHANGELOG.md, searching for v$VERSION..."
            
            CHANGELOG_CONTENT=$(awk "
              /^## \\[?v?${VERSION}\\]?/ { found=1; next }
              found && /^## / { exit }
              found { print }
            " "$SOURCE_DIR/CHANGELOG.md")
            
            CHANGELOG_CONTENT=$(echo "$CHANGELOG_CONTENT" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
            
            if [ -n "$CHANGELOG_CONTENT" ]; then
              echo "âœ“ Found changelog for v$VERSION"
            else
              echo "âŠ˜ No changelog entry for v$VERSION"
            fi
          else
            echo "âŠ˜ No CHANGELOG.md found"
          fi
          
          echo "$CHANGELOG_CONTENT" > /tmp/changelog.md
          
          if [ -n "$CHANGELOG_CONTENT" ]; then
            echo "has_changelog=true" >> $GITHUB_OUTPUT
          else
            echo "has_changelog=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Generate release body
        run: |
          TAG="${{ steps.tag_info.outputs.tag }}"
          PACK_NAME="${{ steps.tag_info.outputs.pack_name }}"
          VERSION="${{ steps.tag_info.outputs.version }}"
          RELEASE_TYPE="${{ steps.tag_info.outputs.release_type }}"
          REPO="${{ github.repository }}"
          
          HAS_MANIFEST="${{ steps.prepare.outputs.has_manifest }}"
          HAS_RULES="${{ steps.prepare.outputs.has_rules }}"
          HAS_CARDS="${{ steps.prepare.outputs.has_cards }}"
          HAS_ASSETS="${{ steps.prepare.outputs.has_assets }}"
          HAS_CHANGELOG="${{ steps.changelog.outputs.has_changelog }}"
          
          BASE_URL="https://github.com/$REPO/releases/download/$TAG"
          
          # Start with header
          cat << EOF > /tmp/release_body.md
          ## $PACK_NAME v$VERSION
          
          **Type:** \`$RELEASE_TYPE\`
          EOF
          
          # Add changelog right after header (if exists)
          if [ "$HAS_CHANGELOG" = "true" ]; then
            cat << EOF >> /tmp/release_body.md
          
          ### ðŸ“ Changes
          EOF
            cat /tmp/changelog.md >> /tmp/release_body.md
          fi
          
          # Add asset links section
          cat << EOF >> /tmp/release_body.md
          
          ---
          
          ### ðŸ“¥ Asset Links
          EOF
          
          if [ "$HAS_MANIFEST" = "true" ]; then
            cat << EOF >> /tmp/release_body.md
          
          **manifest.json** (add this to Cardback):
          \`\`\`
          $BASE_URL/manifest.json
          \`\`\`
          EOF
          fi
          
          if [ "$HAS_RULES" = "true" ]; then
            cat << EOF >> /tmp/release_body.md
          
          **rules.lua:**
          \`\`\`
          $BASE_URL/rules.lua
          \`\`\`
          EOF
          fi
          
          if [ "$HAS_CARDS" = "true" ]; then
            cat << EOF >> /tmp/release_body.md
          
          **cards.json:**
          \`\`\`
          $BASE_URL/cards.json
          \`\`\`
          EOF
          fi
          
          if [ "$HAS_ASSETS" = "true" ]; then
            cat << EOF >> /tmp/release_body.md
          
          **assets.zip:**
          \`\`\`
          $BASE_URL/assets.zip
          \`\`\`
          EOF
          fi
      
      - name: Generate latest release body
        if: steps.config.outputs.create_latest == 'true'
        run: |
          PACK_NAME="${{ steps.tag_info.outputs.pack_name }}"
          VERSION="${{ steps.tag_info.outputs.version }}"
          RELEASE_TYPE="${{ steps.tag_info.outputs.release_type }}"
          REPO="${{ github.repository }}"
          
          HAS_MANIFEST="${{ steps.prepare.outputs.has_manifest }}"
          HAS_RULES="${{ steps.prepare.outputs.has_rules }}"
          HAS_CARDS="${{ steps.prepare.outputs.has_cards }}"
          HAS_ASSETS="${{ steps.prepare.outputs.has_assets }}"
          HAS_CHANGELOG="${{ steps.changelog.outputs.has_changelog }}"
          
          LATEST_TAG="$RELEASE_TYPE/$PACK_NAME/latest"
          BASE_URL="https://github.com/$REPO/releases/download/$LATEST_TAG"
          
          # Start with header
          cat << EOF > /tmp/latest_body.md
          ## $PACK_NAME - Latest Release
          
          **ðŸ“Œ Current version: v$VERSION**
          EOF
          
          # Add changelog right after header (if exists)
          if [ "$HAS_CHANGELOG" = "true" ]; then
            cat << EOF >> /tmp/latest_body.md
          
          ### ðŸ“ Changes in v$VERSION
          EOF
            cat /tmp/changelog.md >> /tmp/latest_body.md
          fi
          
          # Add asset links section
          cat << EOF >> /tmp/latest_body.md
          
          ---
          
          ### ðŸ“¥ Asset Links
          EOF
          
          if [ "$HAS_MANIFEST" = "true" ]; then
            cat << EOF >> /tmp/latest_body.md
          
          **manifest.json** (add this to Cardback):
          \`\`\`
          $BASE_URL/manifest.json
          \`\`\`
          EOF
          fi
          
          if [ "$HAS_RULES" = "true" ]; then
            cat << EOF >> /tmp/latest_body.md
          
          **rules.lua:**
          \`\`\`
          $BASE_URL/rules.lua
          \`\`\`
          EOF
          fi
          
          if [ "$HAS_CARDS" = "true" ]; then
            cat << EOF >> /tmp/latest_body.md
          
          **cards.json:**
          \`\`\`
          $BASE_URL/cards.json
          \`\`\`
          EOF
          fi
          
          if [ "$HAS_ASSETS" = "true" ]; then
            cat << EOF >> /tmp/latest_body.md
          
          **assets.zip:**
          \`\`\`
          $BASE_URL/assets.zip
          \`\`\`
          EOF
          fi
      
      - name: Delete existing versioned release (if any)
        run: |
          TAG="${{ steps.tag_info.outputs.tag }}"
          gh release delete "$TAG" --yes 2>/dev/null || true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Create versioned release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag_info.outputs.tag }}
          name: "${{ steps.tag_info.outputs.release_type }}/${{ steps.tag_info.outputs.pack_name }} v${{ steps.tag_info.outputs.version }}"
          draft: false
          prerelease: false
          body_path: /tmp/release_body.md
          files: release_assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Delete existing latest release (if any)
        if: steps.config.outputs.create_latest == 'true'
        run: |
          RELEASE_TYPE="${{ steps.tag_info.outputs.release_type }}"
          PACK_NAME="${{ steps.tag_info.outputs.pack_name }}"
          LATEST_TAG="${RELEASE_TYPE}/${PACK_NAME}/latest"
          
          gh release delete "$LATEST_TAG" --yes 2>/dev/null || true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Update latest tag
        if: steps.config.outputs.create_latest == 'true'
        run: |
          RELEASE_TYPE="${{ steps.tag_info.outputs.release_type }}"
          PACK_NAME="${{ steps.tag_info.outputs.pack_name }}"
          LATEST_TAG="${RELEASE_TYPE}/${PACK_NAME}/latest"
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git tag -d "$LATEST_TAG" 2>/dev/null || true
          git push origin ":refs/tags/$LATEST_TAG" 2>/dev/null || true
          
          git tag "$LATEST_TAG"
          git push origin "$LATEST_TAG"
          
          echo "âœ“ Updated $LATEST_TAG"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Create latest release
        if: steps.config.outputs.create_latest == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag_info.outputs.release_type }}/${{ steps.tag_info.outputs.pack_name }}/latest
          name: "${{ steps.tag_info.outputs.pack_name }} (Latest)"
          draft: false
          prerelease: false
          body_path: /tmp/latest_body.md
          files: release_assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Update summary release
        if: steps.config.outputs.create_latest == 'true'
        run: |
          REPO="${{ github.repository }}"
          
          echo "=== Updating summary release ==="
          
          # Fetch all tags to ensure we have the latest
          git fetch --tags --force
          
          # Build summary of all latest game releases
          cat << 'EOF' > /tmp/summary.md
          # ðŸŽ® All Latest Games
          
          Quick links to all available game manifests. Copy any URL below and paste it into Cardback to add the game.
          
          ## Games
          
          | Game | Manifest URL |
          |------|--------------|
          EOF
          
          # Find all game/*/latest tags and add to table
          GAME_COUNT=0
          for tag in $(git tag -l "game/*/latest" | sort); do
            GAME_NAME=$(echo "$tag" | cut -d'/' -f2)
            MANIFEST_URL="https://github.com/$REPO/releases/download/$tag/manifest.json"
            
            # Format game name nicely (replace hyphens with spaces, title case)
            DISPLAY_NAME=$(echo "$GAME_NAME" | sed 's/-/ /g' | sed 's/\b\(.\)/\u\1/g')
            
            echo "| $DISPLAY_NAME | \`$MANIFEST_URL\` |" >> /tmp/summary.md
            GAME_COUNT=$((GAME_COUNT + 1))
          done
          
          # Add footer
          cat << EOF >> /tmp/summary.md
          
          ---
          
          **Total games available:** $GAME_COUNT
          
          *This release is automatically updated whenever a new game version is published.*
          EOF
          
          echo "Summary content:"
          cat /tmp/summary.md
          
          # Delete existing summary release and tag
          gh release delete "games-summary" --yes 2>/dev/null || true
          git tag -d "games-summary" 2>/dev/null || true
          git push origin ":refs/tags/games-summary" 2>/dev/null || true
          
          # Create new tag at current commit
          git tag "games-summary"
          git push origin "games-summary"
          
          # Create the summary release and mark it as latest
          gh release create "games-summary" \
            --repo "$REPO" \
            --title "ðŸ“‹ All Available Games" \
            --notes-file /tmp/summary.md \
            --latest
          
          echo "âœ“ Updated summary release with $GAME_COUNT games"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Print summary
        run: |
          RELEASE_TYPE="${{ steps.tag_info.outputs.release_type }}"
          PACK_NAME="${{ steps.tag_info.outputs.pack_name }}"
          VERSION="${{ steps.tag_info.outputs.version }}"
          REPO="${{ github.repository }}"
          TAG="${{ steps.tag_info.outputs.tag }}"
          CREATE_LATEST="${{ steps.config.outputs.create_latest }}"
          
          echo ""
          echo "=============================================="
          echo "ðŸŽ‰ Release complete!"
          echo "=============================================="
          echo ""
          echo "ðŸ“¦ $RELEASE_TYPE/$PACK_NAME v$VERSION"
          echo ""
          echo "ðŸ”— Release:"
          echo "   https://github.com/$REPO/releases/tag/$TAG"
          
          if [ "$CREATE_LATEST" = "true" ]; then
            echo ""
            echo "ðŸ”„ Latest:"
            echo "   https://github.com/$REPO/releases/tag/$RELEASE_TYPE/$PACK_NAME/latest"
            echo ""
            echo "ðŸ“‹ Summary (pinned):"
            echo "   https://github.com/$REPO/releases/tag/games-summary"
          fi
          
          echo ""