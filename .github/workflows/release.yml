name: Release Game Pack

on:
  push:
    tags:
      - '*/[0-9]+.[0-9]+'

jobs:
  release:
    runs-on: ubuntu-latest

    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Parse tag info
        id: tag_info
        run: |
          # GITHUB_REF is like "refs/tags/tic-tac-toe/1.0.0"
          # We strip the prefix to get "tic-tac-toe/1.0.0"
          TAG="${GITHUB_REF#refs/tags/}"
          
          # Split into game name and version
          GAME_NAME="${TAG%/*}"      # Everything before last /
          VERSION="${TAG##*/}"        # Everything after last /
          
          # Save for later steps
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "game_name=$GAME_NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
          # Log for debugging
          echo "ðŸ“¦ Game: $GAME_NAME"
          echo "ðŸ·ï¸  Version: $VERSION"

      - name: Determine source directory
        id: source_dir
        run: |
          GAME_NAME="${{ steps.tag_info.outputs.game_name }}"
          
          if [ -d "games/$GAME_NAME" ]; then
            echo "dir=games/$GAME_NAME" >> $GITHUB_OUTPUT
            echo "ðŸ“‚ Found in games/$GAME_NAME"
          elif [ -d "decks/$GAME_NAME" ]; then
            echo "dir=decks/$GAME_NAME" >> $GITHUB_OUTPUT
            echo "ðŸ“‚ Found in decks/$GAME_NAME"
          else
            echo "âŒ Error: Could not find game or deck: $GAME_NAME"
            echo "Available games:"
            ls -la games/ 2>/dev/null || echo "  (no games folder)"
            echo "Available decks:"
            ls -la decks/ 2>/dev/null || echo "  (no decks folder)"
            exit 1
          fi

      - name: Prepare release assets
        run: |
          SOURCE_DIR="${{ steps.source_dir.outputs.dir }}"
          VERSION="${{ steps.tag_info.outputs.version }}"
          ASSETS_DIR="release_assets"
          
          mkdir -p "$ASSETS_DIR"
          
          echo "=== Preparing release assets ==="
          
          # Copy manifest and update version
          if [ -f "$SOURCE_DIR/manifest.json" ]; then
            jq --arg v "$VERSION" '.version = $v' "$SOURCE_DIR/manifest.json" > "$ASSETS_DIR/manifest.json"
            echo "âœ“ manifest.json (version set to $VERSION)"
          else
            echo "âŒ Error: manifest.json not found in $SOURCE_DIR"
            exit 1
          fi
          
          # Copy rules.lua if exists
          if [ -f "$SOURCE_DIR/rules.lua" ]; then
            cp "$SOURCE_DIR/rules.lua" "$ASSETS_DIR/"
            echo "âœ“ rules.lua"
          else
            echo "âš ï¸ No rules.lua (this is fine for deck packs)"
          fi
          
          # Copy cards.json if exists
          if [ -f "$SOURCE_DIR/cards.json" ]; then
            cp "$SOURCE_DIR/cards.json" "$ASSETS_DIR/"
            echo "âœ“ cards.json"
          else
            echo "âš ï¸ No cards.json"
          fi
          
          # Create assets.zip from cards folder
          if [ -d "$SOURCE_DIR/cards" ]; then
            cd "$SOURCE_DIR/cards"
            zip -r "../../../$ASSETS_DIR/assets.zip" ./*
            cd -
            echo "âœ“ assets.zip ($(unzip -l $ASSETS_DIR/assets.zip | tail -1 | awk '{print $2}') files)"
          else
            echo "âš ï¸ No cards folder to zip"
          fi
          
          echo ""
          echo "=== Release assets ready ==="
          ls -la "$ASSETS_DIR"

      - name: Create versioned release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag_info.outputs.tag }}
          name: "${{ steps.tag_info.outputs.game_name }} v${{ steps.tag_info.outputs.version }}"
          body: |
            ## ${{ steps.tag_info.outputs.game_name }} v${{ steps.tag_info.outputs.version }}
            
            ### ðŸ“¥ Setup
            Add this game to Cardback using the manifest URL:
            ```
            https://github.com/${{ github.repository }}/releases/download/${{ steps.tag_info.outputs.tag }}/manifest.json
            ```
            
            ### ðŸ”„ Latest Version
            To always get the latest version:
            ```
            https://github.com/${{ github.repository }}/releases/download/${{ steps.tag_info.outputs.game_name }}/latest/manifest.json
            ```
          files: release_assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update latest tag
        run: |
          GAME_NAME="${{ steps.tag_info.outputs.game_name }}"
          LATEST_TAG="${GAME_NAME}/latest"
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Delete existing latest tag (local and remote)
          git tag -d "$LATEST_TAG" 2>/dev/null || true
          git push origin ":refs/tags/$LATEST_TAG" 2>/dev/null || true
          
          # Create new latest tag
          git tag "$LATEST_TAG"
          git push origin "$LATEST_TAG"
          
          echo "âœ“ Updated $LATEST_TAG tag"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update latest release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag_info.outputs.game_name }}/latest
          name: "${{ steps.tag_info.outputs.game_name }} (Latest)"
          prerelease: false
          body: |
            ## ${{ steps.tag_info.outputs.game_name }} - Latest Release
            
            **ðŸ“Œ Current version: v${{ steps.tag_info.outputs.version }}**
            
            This release always contains the latest version.
            
            ### ðŸ“¥ Manifest Url
            ```
            https://github.com/${{ github.repository }}/releases/download/${{ steps.tag_info.outputs.game_name }}/latest/manifest.json
            ```
          files: release_assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Print summary
        run: |
          GAME_NAME="${{ steps.tag_info.outputs.game_name }}"
          VERSION="${{ steps.tag_info.outputs.version }}"
          REPO="${{ github.repository }}"
          
          echo ""
          echo "=============================================="
          echo "ðŸŽ‰ Release complete!"
          echo "=============================================="
          echo ""
          echo "ðŸ“¦ $GAME_NAME v$VERSION"
          echo ""
          echo "ðŸ”— Versioned release:"
          echo "   https://github.com/$REPO/releases/tag/$GAME_NAME/$VERSION"
          echo ""
          echo "ðŸ”— Latest release:"
          echo "   https://github.com/$REPO/releases/tag/$GAME_NAME/latest"
          echo ""
          echo "ðŸ“‹ Manifest URL (versioned):"
          echo "   https://github.com/$REPO/releases/download/$GAME_NAME/$VERSION/manifest.json"
          echo ""
          echo "ðŸ“‹ Manifest URL (latest):"
          echo "   https://github.com/$REPO/releases/download/$GAME_NAME/latest/manifest.json"
          echo ""
